#!/usr/bin/env bash
set -euo pipefail

# Open a tmux window for a common task: git | test | server
# Usage: tmux-windowizer <mode>

mode=${1:-}
if [[ -z "$mode" ]]; then
  echo "Usage: tmux-windowizer <git|test|server>" >&2
  exit 1
fi

detect_cmd() {
  case "$mode" in
    git)
      if command -v lazygit >/dev/null 2>&1; then
        echo "lazygit"
      else
        echo "git status; exec \${SHELL:-$SHELL}"
      fi
      ;;
    test)
      if [[ -f go.mod ]] && command -v go >/dev/null 2>&1; then
        echo "go test ./..."
      elif [[ -f Cargo.toml ]] && command -v cargo >/dev/null 2>&1; then
        echo "cargo test"
      elif [[ -f package.json ]]; then
        echo "(command -v pnpm >/dev/null && pnpm test) || (command -v npm >/dev/null && npm test) || (command -v yarn >/dev/null && yarn test) || (echo 'No JS test script'; exec \${SHELL:-$SHELL})"
      elif [[ -f pyproject.toml || -f pytest.ini || -f setup.cfg ]] && command -v pytest >/dev/null 2>&1; then
        echo "pytest -q"
      else
        echo "echo 'No known test command'; exec \${SHELL:-$SHELL}"
      fi
      ;;
    server)
      if [[ -f Justfile || -f justfile ]] && command -v just >/dev/null 2>&1; then
        echo "just dev || just start || just run || exec \${SHELL:-$SHELL}"
      elif [[ -f package.json ]]; then
        echo "(command -v pnpm >/dev/null && (pnpm dev || pnpm start)) || (command -v npm >/dev/null && (npm run dev || npm start)) || (command -v yarn >/dev/null && (yarn dev || yarn start)) || (echo 'No JS dev/start script'; exec \${SHELL:-$SHELL})"
      elif [[ -f go.mod ]] && command -v go >/dev/null 2>&1; then
        echo "go run ./..."
      elif [[ -f Cargo.toml ]] && command -v cargo >/dev/null 2>&1; then
        echo "cargo run"
      else
        echo "echo 'No known server command'; exec \${SHELL:-$SHELL}"
      fi
      ;;
    *)
      echo "echo 'Unknown mode: $mode'; exec \${SHELL:-$SHELL}"
      ;;
  esac
}

cmd=$(detect_cmd)
window_name="$mode"

if [[ -n "${TMUX:-}" ]]; then
  # Open a new tmux window running the command from the current path
  tmux new-window -n "$window_name" -c "$PWD" "$SHELL -lc \"$cmd\""
else
  # Not in tmux; just run the command in the current shell
  exec $SHELL -lc "$cmd"
fi

